<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R&C VIP GOLD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>

    <style>
        /* --- TEMA VIP DARK LUXURY (OTIMIZADO) --- */
        :root { 
            --bg: #050505; 
            --panel: #0a0a0a;
            --gold: #D4AF37; /* Dourado Metálico Premium */
            --gold-dim: #8a701e;
            --text: #e0e0e0;
            --focus-border: 2px solid #D4AF37;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg); 
            color: var(--text);
            font-family: 'Montserrat', sans-serif;
            width: 100vw; height: 100vh; overflow: hidden;
            /* Gradiente fixo leve para dar profundidade sem gastar GPU */
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        }

        .hide { display: none !important; }
        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-center { display: flex; align-items: center; justify-content: center; }

        /* --- FOCO VIP --- */
        .focused {
            border: var(--focus-border) !important;
            background: linear-gradient(90deg, #1f1f1f 0%, #333 100%) !important;
            color: #fff !important;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); /* Sombra leve */
            transform: scale(1.02); /* Scale pequeno para não travar */
            z-index: 50;
        }
        .focused i, .focused span { color: var(--gold) !important; }

        /* --- LOGIN CARD --- */
        .login-box { 
            width: 450px; padding: 40px; 
            background: rgba(10, 10, 10, 0.95); 
            border: 1px solid #333; border-top: 3px solid var(--gold);
            text-align: center; 
        }
        .brand { font-size: 40px; font-weight: 300; letter-spacing: 2px; color: #fff; margin-bottom: 30px; }
        .brand b { font-weight: 700; color: var(--gold); }
        
        .inp { 
            width: 100%; padding: 15px; margin-bottom: 15px; 
            background: #000; border: 1px solid #333; color: var(--gold); 
            text-align: center; font-family: 'Montserrat'; font-weight: 500;
        }
        .btn-login { 
            width: 100%; padding: 15px; background: var(--gold); 
            color: #000; font-weight: 700; border: none; 
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer; 
        }

        /* --- DASHBOARD VIP --- */
        #dash-layer { padding: 40px 60px; justify-content: space-between; }
        
        .dash-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 20px; }
        .user-welcome { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .user-name { font-size: 28px; color: #fff; font-weight: 300; margin-top: 5px; }
        .user-name b { color: var(--gold); font-weight: 700; }

        .dash-stats { 
            display: flex; gap: 40px; margin-top: 40px; 
        }
        .stat-box { 
            border-left: 2px solid var(--gold); padding-left: 15px; 
        }
        .stat-lbl { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { font-size: 18px; color: #ddd; font-weight: 500; margin-top: 5px; }

        .dash-menu { 
            display: flex; gap: 30px; justify-content: center; align-items: center; height: 100%;
        }
        .menu-card { 
            width: 260px; height: 320px; 
            background: #080808; border: 1px solid #222;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .menu-card i { font-size: 60px; color: #333; margin-bottom: 30px; transition: color 0.2s; }
        .menu-card span { font-size: 14px; text-transform: uppercase; letter-spacing: 3px; color: #666; }

        /* --- PLAYER INTERFACE --- */
        #content-layer { display: flex; height: 100vh; background: #000; }
        
        /* Lista de Categorias (Esquerda) */
        .col-cats { width: 280px; background: #050505; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        .cat-head { padding: 20px; font-size: 12px; letter-spacing: 2px; text-align: center; color: var(--gold); border-bottom: 1px solid #222; }
        .list-wrap { flex: 1; overflow-y: auto; }
        .list-item { 
            padding: 15px 20px; font-size: 13px; color: #777; border-bottom: 1px solid #0e0e0e; 
            transition: all 0.1s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .list-item.active { background: #111; color: var(--gold); border-left: 3px solid var(--gold); font-weight: 700; }
        
        /* Lista de Canais (Meio) */
        .col-chans { width: 350px; background: #0a0a0a; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        .search-box { padding: 15px; border-bottom: 1px solid #222; }
        .srch-inp { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 10px; text-align: center; text-transform: uppercase; font-size: 12px; }
        
        /* Área de Vídeo (Direita) */
        .col-video { flex: 1; background: #000; position: relative; display: flex; flex-direction: column; }
        .vid-wrapper { 
            width: 100%; height: 60%; background: #000; position: relative; 
            border-bottom: 2px solid var(--gold);
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        .meta-info { padding: 30px; flex: 1; background: #080808; }
        .meta-name { font-size: 24px; color: var(--gold); font-weight: 300; margin-bottom: 10px; }
        .meta-desc { font-size: 13px; color: #555; line-height: 1.5; max-width: 80%; }

        /* Botões Coloridos */
        .color-keys { 
            position: absolute; bottom: 20px; right: 30px; display: flex; gap: 20px; 
        }
        .k-btn { display: flex; align-items: center; gap: 8px; font-size: 10px; font-weight: 700; color: #444; text-transform: uppercase; }
        .dot { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* Fullscreen */
        .fullscreen { 
            position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; 
            z-index: 9999; border: none !important;
        }

        /* Loading */
        #loader { background: rgba(0,0,0,0.9); z-index: 20000; color: var(--gold); font-size: 12px; letter-spacing: 3px; }
        .spin { width: 40px; height: 40px; border: 2px solid #333; border-top: 2px solid var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% {transform: rotate(0deg)} 100% {transform: rotate(360deg)} }

        #osd { position: absolute; top: 20px; right: 20px; background: var(--gold); color: #000; padding: 5px 15px; font-weight: 700; font-size: 12px; display: none; z-index: 10001; }

        ::-webkit-scrollbar { width: 2px; }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); }
    </style>
</head>
<body onload="App.init()">

    <div id="loader" class="layer flex-center flex-col hide">
        <div class="spin"></div>
        <div>CARREGANDO</div>
    </div>

    <div id="scr-login" class="layer flex-center">
        <div class="login-box">
            <div class="brand">R&C <b>VIP</b></div>
            <input type="text" id="i0" class="inp" placeholder="DNS SERVER" autocomplete="off">
            <input type="text" id="i1" class="inp" placeholder="USUÁRIO" autocomplete="off">
            <input type="password" id="i2" class="inp" placeholder="SENHA" autocomplete="off">
            <button id="i3" class="btn-login" onclick="App.login()">CONECTAR</button>
            <div id="msg-login" style="color:#d44; margin-top:15px; font-size:11px;"></div>
        </div>
    </div>

    <div id="scr-dash" class="layer hide flex-col">
        <div class="dash-header">
            <div>
                <div class="user-welcome">BEM-VINDO AO VIP</div>
                <div class="user-name" id="u-name">USUÁRIO <b>GOLD</b></div>
                
                <div class="dash-stats">
                    <div class="stat-box">
                        <div class="stat-lbl">VENCIMENTO</div>
                        <div class="stat-val" id="u-exp">--/--/----</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-lbl">CONEXÕES</div>
                        <div class="stat-val" id="u-conn">0 / 1</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-lbl">DATA ATUAL</div>
                        <div class="stat-val" id="u-date">--/--</div>
                    </div>
                </div>
            </div>
            <div class="brand" style="font-size:30px">R&C <b>VIP</b></div>
        </div>

        <div class="dash-menu">
            <div id="m0" class="menu-card" onclick="App.openTV()">
                <i class="fas fa-tv"></i>
                <span>TV AO VIVO</span>
            </div>
            <div id="m1" class="menu-card" onclick="App.logout()">
                <i class="fas fa-power-off"></i>
                <span>SAIR</span>
            </div>
        </div>
    </div>

    <div id="scr-play" class="layer hide">
        <div class="col-cats">
            <div class="cat-head">CATEGORIAS</div>
            <div id="list-cats" class="list-wrap"></div>
        </div>
        <div class="col-chans">
            <div class="search-box">
                <input type="text" id="inp-search" class="srch-inp" placeholder="BUSCAR CANAL..." disabled>
            </div>
            <div id="list-chans" class="list-wrap"></div>
        </div>
        <div class="col-video">
            <div id="vid-box" class="vid-wrapper">
                <video id="player" playsinline webkit-playsinline></video>
                <div id="osd"></div>
            </div>
            <div class="meta-info">
                <div id="meta-title" class="meta-name">SELECIONE UM CANAL</div>
                <div class="meta-desc">
                    Utilize as setas para navegar. Pressione OK para assistir.<br>
                    Se o canal travar, aguarde a reconexão automática.
                </div>
                
                <div class="color-keys">
                    <div class="k-btn"><div class="dot" style="background:#ff4444"></div> TELA CHEIA</div>
                    <div class="k-btn"><div class="dot" style="background:#00C851"></div> TOPO</div>
                    <div class="k-btn"><div class="dot" style="background:#ffbb33"></div> BUSCA</div>
                    <div class="k-btn"><div class="dot" style="background:#33b5e5"></div> MENU</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ANTI-TRAVAMENTO (EXTREMA) ---
        var HlsConfig = {
            autoStartLoad: true,
            startPosition: -1,
            // Buffers minúsculos para não estourar a RAM da Philco
            maxBufferLength: 3,      // Só mantém 3s de vídeo na memória
            maxMaxBufferLength: 5,   // Limite máximo absoluto
            maxBufferSize: 5*1000*1000, // 5MB max
            backBufferLength: 0,     // Apaga o que já passou na hora
            enableWorker: true,
            manifestLoadingTimeOut: 15000,
            levelLoadingTimeOut: 15000,
            fragLoadingTimeOut: 15000,
            capLevelToPlayerSize: true // Tenta não baixar 4K se a janela for pequena
        };

        var Player = {
            hls: null, video: null, url: '', timer: null,
            init: function() { this.video = document.getElementById('player'); },
            play: function(url) {
                this.stop();
                this.url = url;
                if(url.indexOf('.m3u8')===-1) url = url.replace('.ts','.m3u8'); // Forçar HLS
                
                if(Hls.isSupported()) {
                    this.hls = new Hls(HlsConfig);
                    this.hls.loadSource(url);
                    this.hls.attachMedia(this.video);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, function(){ 
                        Player.video.play().catch(e=>{console.log(e)}); 
                    });
                    this.hls.on(Hls.Events.ERROR, function(e,d){
                        if(d.fatal) {
                             if(d.type === Hls.ErrorTypes.NETWORK_ERROR) {
                                 App.osd("RECONECTANDO...");
                                 Player.hls.startLoad();
                             } else {
                                 Player.restart();
                             }
                        }
                    });
                } else {
                    this.video.src = url;
                    this.video.play();
                }
                this.watchdog();
            },
            stop: function() {
                if(this.timer) clearInterval(this.timer);
                if(this.hls) { this.hls.destroy(); this.hls=null; }
                this.video.pause(); this.video.removeAttribute('src'); this.video.load();
            },
            watchdog: function() {
                // Monitora travamentos a cada 2s
                var lastTime = 0; var stuck = 0;
                this.timer = setInterval(function(){
                    if(!Player.video || Player.video.paused) return;
                    if(Math.abs(Player.video.currentTime - lastTime) < 0.1) {
                        stuck++;
                        if(stuck > 5) { // 10s travado
                            App.osd("RECUPERANDO...");
                            Player.restart();
                            stuck = 0;
                        }
                    } else { stuck = 0; lastTime = Player.video.currentTime; }
                }, 2000);
            },
            restart: function() {
                setTimeout(function(){ if(Player.url) Player.play(Player.url); }, 1000);
            }
        };

        var App = {
            scr: 0, idx: 0, zone: 0, lastCat: 0, creds: {}, data: [], fullList: [],
            
            init: function() {
                Player.init();
                var c = localStorage.getItem('vip_creds');
                if(c) {
                    var p = JSON.parse(c);
                    document.getElementById('i0').value = p.h;
                    document.getElementById('i1').value = p.u;
                    document.getElementById('i2').value = p.p;
                }
                setInterval(this.clock, 60000); this.clock();
                this.updateFocus();
            },
            
            clock: function() {
                var d = new Date();
                document.getElementById('u-date').innerText = d.getDate()+'/'+(d.getMonth()+1);
            },
            
            req: function(u, cb) {
                var x = new XMLHttpRequest();
                x.open('GET', u, true); x.timeout = 20000;
                x.onload = function(){ if(x.status==200) try{cb(JSON.parse(x.responseText))}catch(e){cb(null)} else cb(null)};
                x.onerror = function(){cb(null)}; x.ontimeout = function(){cb(null)};
                x.send();
            },

            login: function() {
                var h = document.getElementById('i0').value.trim();
                var u = document.getElementById('i1').value.trim();
                var p = document.getElementById('i2').value.trim();
                if(!h.startsWith('http')) h = 'http://'+h;
                if(h.endsWith('/')) h = h.slice(0,-1);

                this.load(true);
                this.req(h+"/player_api.php?username="+u+"&password="+p, function(d){
                    App.load(false);
                    if(d && d.user_info && d.user_info.auth==1) {
                        App.creds = {h:h,u:u,p:p};
                        localStorage.setItem('vip_creds', JSON.stringify(App.creds));
                        
                        // Populate Dash
                        document.getElementById('u-name').innerHTML = d.user_info.username + " <b>VIP</b>";
                        var exp = d.user_info.exp_date;
                        document.getElementById('u-exp').innerText = exp ? new Date(exp*1000).toLocaleDateString() : "ILIMITADO";
                        document.getElementById('u-conn').innerText = (d.user_info.active_cons||0) + " / " + (d.user_info.max_connections||1);
                        
                        App.setScr(1);
                    } else {
                        document.getElementById('msg-login').innerText = "ACESSO NEGADO";
                    }
                });
            },

            logout: function() { localStorage.removeItem('vip_creds'); location.reload(); },

            setScr: function(n) {
                if(n===1) Player.stop();
                this.scr = n; this.idx = 0; this.zone = 0;
                document.querySelectorAll('.layer').forEach(l=>l.classList.add('hide'));
                
                if(n===0) document.getElementById('scr-login').classList.remove('hide');
                if(n===1) document.getElementById('scr-dash').classList.remove('hide');
                if(n===2) document.getElementById('scr-play').classList.remove('hide');
                
                this.updateFocus();
            },

            openTV: function() {
                this.setScr(2);
                this.load(true);
                document.getElementById('list-cats').innerHTML = '';
                document.getElementById('list-chans').innerHTML = '';
                
                var u = this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_live_categories";
                this.req(u, function(d){
                    App.load(false);
                    if(d) {
                        var h='';
                        for(var i=0; i<d.length; i++) h+='<div id="c'+i+'" class="list-item" data-id="'+d[i].category_id+'">'+d[i].category_name+'</div>';
                        document.getElementById('list-cats').innerHTML = h;
                        App.zone=0; App.idx=0; App.updateFocus();
                    }
                });
            },

            loadCat: function(i) {
                var el = document.getElementById('c'+i); if(!el) return;
                var id = el.getAttribute('data-id');
                document.querySelectorAll('.list-item').forEach(e=>e.classList.remove('active'));
                el.classList.add('active');
                
                this.load(true);
                var u = this.creds.h+"/player_api.php?username="+this.creds.u+"&password="+this.creds.p+"&action=get_live_streams&category_id="+id;
                this.req(u, function(d){
                    App.load(false);
                    if(d) {
                        App.fullList = d; // Cache for search
                        App.renderList(d);
                    }
                });
            },
            
            renderList: function(list) {
                // HARD LIMIT 80 itens para não travar a Philco
                var max = list.length > 80 ? 80 : list.length;
                var h = '';
                App.data = [];
                for(var k=0; k<max; k++) {
                    App.data.push(list[k]);
                    h += '<div id="r'+k+'" class="list-item">'+list[k].name+'</div>';
                }
                document.getElementById('list-chans').innerHTML = h;
                App.zone=2; App.idx=0; App.updateFocus();
            },

            play: function() {
                var item = this.data[this.idx];
                if(!item) return;
                
                document.querySelectorAll('.list-item').forEach(e=>e.classList.remove('active')); // Limpa visual anterior
                var el = document.getElementById('r'+this.idx); if(el) el.classList.add('active');
                
                document.getElementById('meta-title').innerText = item.name;
                var u = this.creds.h+"/live/"+this.creds.u+"/"+this.creds.p+"/"+item.stream_id+".m3u8";
                Player.play(u);
            },

            search: function() {
                var t = document.getElementById('inp-search').value.toLowerCase();
                if(t.length < 3) return;
                var res = this.fullList.filter(x => x.name.toLowerCase().includes(t));
                this.renderList(res);
            },

            toggleFull: function() {
                var v = document.getElementById('vid-box');
                if(v.classList.contains('fullscreen')) v.classList.remove('fullscreen');
                else { v.classList.add('fullscreen'); this.osd("TELA CHEIA"); }
            },

            load: function(b) { b ? document.getElementById('loader').classList.remove('hide') : document.getElementById('loader').classList.add('hide'); },
            osd: function(t) { var o=document.getElementById('osd'); o.innerText=t; o.style.display='block'; setTimeout(()=>o.style.display='none',3000); },

            updateFocus: function() {
                document.querySelectorAll('.focused').forEach(e=>e.classList.remove('focused'));
                var el;
                if(this.scr===0) el=document.getElementById('i'+this.idx);
                if(this.scr===1) el=document.getElementById('m'+this.idx);
                if(this.scr===2) {
                    if(this.zone===0) el=document.getElementById('c'+this.idx);
                    if(this.zone===1) el=document.getElementById('inp-search');
                    if(this.zone===2) el=document.getElementById('r'+this.idx);
                }
                if(el) {
                    el.classList.add('focused');
                    if(el.tagName!=='INPUT') { document.activeElement.blur(); el.scrollIntoView({block:'center', behavior:'auto'}); }
                    else el.focus();
                }
            },
            
            move: function(d) {
                // 0:Up, 1:Down, 2:Left, 3:Right
                if(this.scr===0) { if(d===1 && this.idx<3) this.idx++; if(d===0 && this.idx>0) this.idx--; }
                if(this.scr===1) { if(d===3) this.idx=1; if(d===2) this.idx=0; }
                if(this.scr===2) {
                    if(document.getElementById('vid-box').classList.contains('fullscreen')) return;
                    if(this.zone===0) {
                        var max = document.getElementById('list-cats').children.length-1;
                        if(d===1 && this.idx<max) this.idx++;
                        if(d===0 && this.idx>0) this.idx--;
                        if(d===3) { this.zone=2; this.idx=0; }
                    } else if(this.zone===2) {
                        var max = App.data.length-1;
                        if(d===1 && this.idx<max) this.idx++;
                        if(d===0) { if(this.idx>0) this.idx--; else { this.zone=1; } }
                        if(d===2) { this.zone=0; this.idx=this.lastCat; }
                    } else if(this.zone===1) {
                        if(d===1) { this.zone=2; this.idx=0; }
                        if(d===2) { this.zone=0; this.idx=this.lastCat; }
                    }
                }
                this.updateFocus();
            },
            
            action: function() {
                if(this.scr===0) { if(this.idx===3) this.login(); }
                if(this.scr===1) { if(this.idx===0) this.openTV(); else this.logout(); }
                if(this.scr===2) {
                    if(document.getElementById('vid-box').classList.contains('fullscreen')) { this.toggleFull(); return; }
                    if(this.zone===0) { this.lastCat=this.idx; this.loadCat(this.idx); }
                    if(this.zone===1) this.search();
                    if(this.zone===2) this.play();
                }
            },
            
            back: function() {
                if(document.getElementById('vid-box').classList.contains('fullscreen')) { this.toggleFull(); return; }
                if(this.scr===2) {
                    if(this.zone===2||this.zone===1) { this.zone=0; this.idx=this.lastCat; this.updateFocus(); return; }
                    this.setScr(1); return;
                }
                if(this.scr===1) this.logout();
            }
        };

        document.addEventListener('keydown', function(e){
            var k = e.keyCode;
            // Botões Coloridos
            if(k==403||k==82) App.toggleFull(); // RED
            if(k==404||k==71) { if(App.scr==2&&App.zone==2) { App.idx=0; App.updateFocus(); } } // GREEN
            if(k==405||k==89) { if(App.scr==2) { App.zone=1; App.updateFocus(); } } // YELLOW
            if(k==406||k==66) { if(App.scr==2) App.setScr(1); } // BLUE

            if(k==37) {e.preventDefault(); App.move(2)}
            if(k==38) {e.preventDefault(); App.move(0)}
            if(k==39) {e.preventDefault(); App.move(3)}
            if(k==40) {e.preventDefault(); App.move(1)}
            if(k==13) {e.preventDefault(); App.action()}
            if(k==8||k==27||k==461) {e.preventDefault(); App.back()}
        });
    </script>
</body>
</html>
